<!DOCTYPE html>
<html>
<body>

<h1>Share Your ThoughtsðŸ§¡</h1>

<form id="form">
    <input id="name" placeholder="Name" required><br>
    <input id="email" placeholder="Email" type="email" required><br>
    <input id="password" placeholder="Password" type="password" required><br>
    <button type="submit">Insert</button>
</form>


<table border="1">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
const getEl = id => document.getElementById(id);

const form = getEl('form');
form.onsubmit = async e => {
    e.preventDefault();

    const res = await fetch('http://localhost:3000/users/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: getEl('name').value,
            email: getEl('email').value,
            password: getEl('password').value
        })
    });

    if (!res.ok) {
        alert('Insert failed!');
        return;
    }

    alert('Data inserted successfully!');
    form.reset();
    loadUsers();
};

async function loadUsers() {
    const res = await fetch('http://localhost:3000/users/display');
    const users = await res.json();
    getEl('tableBody').innerHTML = users.map(user => `
        <tr id="row-${user.id}">
            <td>${user.id}</td>
            <td id="name-${user.id}">${user.name}</td>
            <td id="email-${user.id}">${user.email}</td>
            <td>
                <button onclick="editUser(${user.id})">Edit</button>
                <button onclick="saveUser(${user.id})" id="save-${user.id}" hidden>Save</button>
                <button onclick="cancelEdit(${user.id})" id="cancel-${user.id}" hidden>Cancel</button>
                <button onclick="deleteUser(${user.id})" style="color:red;">Delete</button>
            </td>
        </tr>
    `).join('');
}

loadUsers();

function editUser(id) {
    getEl(`name-${id}`).innerHTML = `<input id="edit-name-${id}" value="${getEl(`name-${id}`).innerText}">`;
    getEl(`email-${id}`).innerHTML = `<input id="edit-email-${id}" value="${getEl(`email-${id}`).innerText}">`;

    getEl(`save-${id}`).hidden = false;
    getEl(`cancel-${id}`).hidden = false;
}

async function saveUser(id) {
    try {
        const res = await fetch(`http://localhost:3000/users/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: getEl(`edit-name-${id}`).value,
                email: getEl(`edit-email-${id}`).value
            })
        });

        if (!res.ok) throw new Error('Update failed');

        const user = await res.json();
        getEl(`name-${id}`).innerHTML = user.name;
        getEl(`email-${id}`).innerHTML = user.email;
        getEl(`save-${id}`).hidden = true;
        getEl(`cancel-${id}`).hidden = true;

        alert('User updated!');
    } catch (err) {
        console.error(err);
        alert('Update failed');
        cancelEdit(id);
    }
}

function cancelEdit(id) {
    fetch(`http://localhost:3000/users/${id}`)
        .then(res => res.json())
        .then(user => {
            getEl(`name-${id}`).innerHTML = user.name;
            getEl(`email-${id}`).innerHTML = user.email;
            getEl(`save-${id}`).hidden = true;
            getEl(`cancel-${id}`).hidden = true;
        });
}

async function deleteUser(id) {
    if (!confirm('Are you sure?')) return;

    try {
        await fetch(`http://localhost:3000/users/${id}`, { method: 'DELETE' });
        getEl(`row-${id}`).remove();
        alert('User deleted successfully!');
    } catch (err) {
        console.error(err);
        alert('Failed to delete user');
    }
}
</script>

</body>
</html>
